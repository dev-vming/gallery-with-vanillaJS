<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const canvas = document.createElement("canvas");
      const width = 720;
      const height = 250;
      canvas.width = width * window.devicePixelRatio;
      canvas.height = height * window.devicePixelRatio;
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      document.body.appendChild(canvas);
      const ctx = canvas.getContext("2d");
      ctx.scale(window.devicePixelRatio, window.devicePixelRatio);

      ctx.fillRect(0,0,width,height);
      const audio = new Audio(); // document.createElement('audio')와 동일
      audio.src = './audio/01.mp3';

      canvas.onclick = () => {
        audio.play();
        const analyser= connectAudio();
        draw(analyser);
      }

      function connectAudio() {
        const audioContext = 
          new window.AudioContext() || window.webkitAudioContext();
        const audioSource = audioContext.createMediaElementSource(audio);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        audioSource.connect(analyser);
        analyser.connect(audioContext.destination);
        return analyser;
      }

      function draw(analyser){
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);

        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fillRect(0,0,width,height);

        const barWidth = (width/bufferLength*2);
        let barheight = 0;
        let x = 0;

        ctx.save(); // 기존 컨텍스트가 가진 정보들을 스택에 담음
        for(let i=0; i<bufferLength; i++){
          barHeight = dataArray[i];
          ctx.fillStyle = '#55b';
          ctx.fillRect(x,height-barHeight,barWidth,barHeight);
          x+=barWidth;
        }
        ctx.restore();
        requestAnimationFrame(()=>draw(analyser))
      }
    </script>
  </body>
</html>
